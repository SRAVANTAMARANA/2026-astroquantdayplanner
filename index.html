<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Events Day Planner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        h1 { color: #2c3e50; }
        .event-block { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 1.5em; margin-bottom: 2em; }
        .nakshatra-changes { margin-top: 1em; }
        .nakshatra-changes table { width: 100%; border-collapse: collapse; }
        .nakshatra-changes th, .nakshatra-changes td { border: 1px solid #ddd; padding: 0.5em; text-align: center; }
        .nakshatra-changes th { background: #e9ecef; }
        .tithi { font-size: 1.2em; margin-top: 1em; }
        .date-picker { margin-bottom: 1em; }
    </style>
</head>
<body>
    <h1>Astro Events Day Planner</h1>
    <div class="date-picker">
        <label for="date">Select Date: </label>
        <input type="date" id="date" />
        <button onclick="loadEvents()">Show Events</button>
    </div>
    <div id="events" class="event-block">Loading...</div>
    <div id="chart-block" class="event-block" style="padding:0;">
        <h2 style="margin:1em 0 0.5em 0;">XAUUSD Live Chart</h2>
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
            <div id="tradingview_xauusd"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
            new TradingView.widget({
                "width": "100%",
                "height": 420,
                "symbol": "OANDA:XAUUSD",
                "interval": "60",
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": true,
                "container_id": "tradingview_xauusd",
                "withdateranges": true,
                "allow_symbol_change": true,
                "details": true,
                "studies": [
                    "MACD@tv-basicstudies",
                    "RSI@tv-basicstudies",
                    "StochasticRSI@tv-basicstudies"
                ],
                "watchlist": ["OANDA:XAUUSD", "OANDA:EURUSD", "OANDA:GBPUSD", "OANDA:USDJPY", "OANDA:SPX500USD"],
                "intervals": ["1", "5", "15", "30", "60", "120", "240", "D", "W", "M"]
            });
            </script>
        </div>
        <!-- TradingView Widget END -->
    </div>

    <!-- ML Analytics Dashboard Section -->
    <div id="ml-dashboard" class="event-block">
        <h2>ML Analytics Dashboard</h2>
        <input type="file" id="excelFile" accept=".xlsx" />
        <button onclick="loadExcel()">Load Analytics</button>
        <a href="astro_observer_deep_analytics.xlsx" download style="display:inline-block; margin-top:1em; font-weight:bold; color:#0984e3;">Download Latest Analytics Excel</a>
        <div id="ml-stats"></div>
        <canvas id="featureChart" width="600" height="300" style="margin-top:2em;"></canvas>
        <canvas id="predChart" width="600" height="300" style="margin-top:2em;"></canvas>
    </div>
    <script>
        // ML Analytics Excel Loader
        function loadExcel() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files.length) {
                document.getElementById('ml-stats').innerHTML = 'Please select an Excel file.';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                import('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js').then(XLSX => {
                    const workbook = XLSX.read(data, {type: 'array'});
                    // ML Stats
                    let stats = '';
                    if (workbook.SheetNames.includes('ML_Stats')) {
                        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['ML_Stats']);
                        stats += '<h3>Model Stats</h3><pre>' + JSON.stringify(sheet, null, 2) + '</pre>';
                    }
                    // Feature Importance
                    let features = [];
                    let importances = [];
                    if (workbook.SheetNames.includes('FeatureImportance')) {
                        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['FeatureImportance']);
                        features = sheet.map(r => r.feature);
                        importances = sheet.map(r => r.importance);
                    }
                    // Predictions
                    let y_true = [], y_pred = [];
                    if (workbook.SheetNames.includes('Predictions')) {
                        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Predictions']);
                        y_true = sheet.map(r => r.y_true);
                        y_pred = sheet.map(r => r.y_pred);
                    }
                    document.getElementById('ml-stats').innerHTML = stats;
                    // Draw charts
                    drawFeatureChart(features, importances);
                    drawPredChart(y_true, y_pred);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function drawFeatureChart(features, importances) {
            const ctx = document.getElementById('featureChart').getContext('2d');
            if (window.featureChartObj) window.featureChartObj.destroy();
            window.featureChartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: features,
                    datasets: [{
                        label: 'Feature Importance',
                        data: importances,
                        backgroundColor: '#0984e3'
                    }]
                },
                options: {responsive:true, plugins:{legend:{display:false}}}
            });
        }

        function drawPredChart(y_true, y_pred) {
            const ctx = document.getElementById('predChart').getContext('2d');
            if (window.predChartObj) window.predChartObj.destroy();
            window.predChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: y_true.map((_,i)=>i+1),
                    datasets: [
                        {label:'True Return',data:y_true,borderColor:'#00b894',fill:false},
                        {label:'Predicted Return',data:y_pred,borderColor:'#d35400',fill:false}
                    ]
                },
                options: {responsive:true}
            });
        }

        // Load Chart.js for visualization
        (function(){
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            document.head.appendChild(script);
        })();
    async function loadEvents() {
        const dateInput = document.getElementById('date');
        let date = dateInput.value;
        let url = '/astro-events';
        if (date) url += `?date=${date}`;
        document.getElementById('events').innerHTML = 'Loading...';
        try {
            const res = await fetch(url);
            const data = await res.json();
            renderEvents(data);
        } catch (e) {
            document.getElementById('events').innerHTML = 'Failed to load events.';
        }
    }

    function renderEvents(data) {
        let html = `<h2>${data.date} (${data.weekday})</h2>`;
        html += `<div class=\"tithi\"><strong>Tithi:</strong> ${data.tithi}</div>`;
        html += `<div class=\"nakshatra-changes\"><h3>Nakshatra Periods</h3><table><tr><th>Nakshatra</th><th>From (IST)</th><th>To (IST)</th><th>Moon 째 Start</th><th>Moon 째 End</th><th>Sun 째 Start</th><th>Sun 째 End</th></tr>`;
        for (const p of (data.moon.periods || [])) {
            html += `<tr><td>${p.nakshatra}</td><td>${p.from_time}</td><td>${p.to_time}</td><td>${p.moon_longitude_start}</td><td>${p.moon_longitude_end}</td><td>${p.sun_longitude_start}</td><td>${p.sun_longitude_end}</td></tr>`;
        }
        html += `</table></div>`;

        // Add a simple bar graph for nakshatra periods
        html += `<div style='margin-top:2em'><h3>Nakshatra Timeline</h3><div id='nakshatra-graph' style='height:40px; width:100%; background:#eee; border-radius:6px; position:relative; overflow:hidden'></div></div>`;
        setTimeout(() => renderNakshatraGraph(data.moon.periods || []), 0);
        document.getElementById('events').innerHTML = html;
        function parseTimeToMinutes(t) {
            // t: "HH:MM IST"
            const [h, m] = t.split(' ')[0].split(':').map(Number);
            return h * 60 + m;
        }

        function renderNakshatraGraph(periods) {
            const graph = document.getElementById('nakshatra-graph');
            if (!graph) return;
            const totalMinutes = 24 * 60;
            let html = '';
            const colors = [
                '#6c5ce7', '#00b894', '#fdcb6e', '#e17055', '#0984e3', '#00cec9', '#fab1a0', '#d35400', '#636e72',
                '#b2bec3', '#fd79a8', '#e84393', '#2d3436', '#00b894', '#fdcb6e', '#e17055', '#0984e3', '#00cec9',
                '#fab1a0', '#d35400', '#636e72', '#b2bec3', '#fd79a8', '#e84393', '#2d3436', '#00b894', '#fdcb6e', '#e17055'
            ];
            let offset = 0;
            for (let i = 0; i < periods.length; ++i) {
                const p = periods[i];
                const from = parseTimeToMinutes(p.from_time);
                const to = parseTimeToMinutes(p.to_time);
                let width = to - from;
                if (width < 0) width += totalMinutes; // handle midnight wrap
                const percent = (width / totalMinutes) * 100;
                html += `<div title='${p.nakshatra}: ${p.from_time} - ${p.to_time}' style='display:inline-block; height:100%; width:${percent}%; background:${colors[i%colors.length]};'></div>`;
                offset += width;
            }
            graph.innerHTML = html;
        }
    }

    // Load today's events on page load
    window.onload = function() {
        const today = new Date().toISOString().slice(0,10);
        document.getElementById('date').value = today;
        loadEvents();
    }
    </script>
</body>
</html>
